https://wiki.internetcomputer.org/wiki/IC_P2P_(peer_to_peer)_layer



# P2P层

P2P层的任务是在子网的节点副本中传递协议消息。这些协议消息包括

- 用于实现共识的消息，例如，区块提案（block proposals），公证（notarizations）等（详见[共识层](#5 共识层)）
- 入口消息（详见消息路由层）



---



当边缘节点把消息发过来的时候，由副本 P2P 层接收消息、广播消息。

这些消息有：

* 用于实现共识的各种签名消息

* 用户客户端发来的输入消息

如果是用户发的输入消息，P2P 层把这些消息按先后顺序排好，以便共识层将荷载打包出块。

P2P 层基本上是个广播通道。它的设计目的是为了确保如果一个诚实的副本广播了一条消息，那么这条消息最终将会被子网中的所有诚实节点所接收。P2P 层要负责保障高吞吐量，高吞吐量比低延迟更重要。并且故障的机器不影响诚实副本之间的相互通信。



---





注意到，在共识协议中，一些消息，尤其是区块提案（会非常大），将被所有副本反复广播。这对确保协议的正确运作是必须的。但是，如果单纯这样实现，将会是巨大的资源浪费。为了避免副本广播相同的消息，P2P层使用了**公告-请求-传递**的机制。它不会直接传递（大）消息，而是广播该消息的（小）**公告**：如果副本收到这样的公告并且没有收到过对应的消息，将认定该消息是重要的，副本将**请求**该消息的**传递**。这个策略以更高延迟的代价，降低了带宽使用。对于小消息而言，牺牲延迟追求带宽是不值得的，可以直接发送消息而不是公告。



对于相对较小的子网而言，希望广播消息的节点副本，会将公告发送至子网中的所有节点副本。对于较大的子网，**公告-请求-传递**机制可以在一个**覆盖网络（overlay network）**上运行。覆盖网络是一个连接的无向图，子网内的节点副本组成其顶点。如果图中有一条边连接两个副本，那他们是**对等节点（peers）**，副本仅和它的对等节点通信。因此，当副本希望广播消息时，他将该消息的公告发送给它的对等节点。这些对等节点在收到公告后，可能会请求消息的传递，如果满足特定条件，这些对等节点会将该消息的公告发送给他们的对等节点。这本质上是一个**gossip network**。这个策略用比先前更高的延迟代价，再次降低了带宽使用。







好的，那我来简单解释一下 IC P2P 网络层的概念。

首先，我们需要知道 P2P 是什么。P2P 是 Peer-to-Peer 的缩写，意思是点对点。在计算机网络中，P2P 意味着不需要通过中心服务器来进行通信，而是可以直接与其他设备相连。

IC P2P 是一种特殊的 P2P 网络，它是一个用于构建去中心化应用程序的开放式协议，旨在提高互联网的安全性和隐私性。它使用了一些先进的技术来确保通信安全，例如加密和区块链技术。

IC P2P 网络层的作用是连接不同的节点，使它们可以相互通信并传输数据。这个网络层类似于互联网中的网络层，但是有一些不同之处。IC P2P 网络层可以自动识别节点，并根据它们的地理位置和网络性能进行路由。这意味着如果一个节点与另一个节点距离很远或网络连接较差，它们将不会直接连接，而是会选择与它们更接近的节点进行通信，从而提高通信效率和速度。

总的来说，IC P2P 网络层是一个支持去中心化通信的网络协议，它可以让应用程序在不需要中心化服务器的情况下进行通信，提高了互联网的安全性和可靠性。







互联网计算机（IC）的P2P（点对点）层负责在子网内部的节点之间传递消息。即便在恶意活动的情况下，它也保证消息传输的高效性。

**工件（Artifacts）**

每个P2P层的客户端（例如上层的共识组件）都维护一组工件（工件池）。工件是在子网内节点之间交换的消息，用于创建、验证和达成共识。这些工件包括共识块建议、用户的进入消息或HTTPS外呼功能的响应签名等。节点将这些工件分发给各个节点，以便所有节点对子网状态有相同的视图。这样，节点在创建块建议时可以包含发给其他节点的进入消息，如果节点断开连接或加入新子网，可以高效地追赶上进度。

当需要将工件传递给节点时，P2P层会被工件池调用。这可能发生在节点本身生成新工件（例如，一个新的块建议）或者它想要中继从其他节点接收到的工件的情况下。

**广告（Adverts）**

为了节省带宽，避免将工件发送给已经在其池中拥有该工件的节点，当客户端请求广播工件时，P2P层并不会立即将工件发送给所有节点。相反，它创建一条名为“广告”的消息，这是一条非常小的消息，带有工件的哈希值和一些其他元数据，并将此广告广播给所有节点。其他节点看到广告后，决定是否从该节点下载相应的工件，如果是，则发送一个明确的请求消息给该节点，该节点将响应包含工件本身的消息。

这种方法明显将吞吐量换成了延迟，但对于IC的共识协议的需求来说，这是理想的。

为了在所有节点之间公平地共享带宽，并避免内存耗尽，限制了正在进行的请求数量。

**数据块（Chunks）**

某些工件（如状态同步工件）过大，无法作为单个块发送。对于这些工件，一个广告代表一组数据块，这些数据块组合在一起构成一个完整的工件。当下载的工件可以分块时，P2P层会尝试从多个发布相应工件的节点下载相应的数据块。这样可以加快下载速度，更好地利用带宽。

**工件的验证**

每个广告都包含相应工件的完整性哈希。完整性哈希是将加密哈希函数应用于工件内容的结果。当工件下载完成时，同样的函数会在本地应用于下载的内容，只有当结果与广告的哈希值匹配时，工件才会被处理并提供给相应的客户端工件池。

需要注意的是，这只是第一层防御：恶意节点可以发送一个带有完整性哈希的广告，然后发送与广告哈希相匹配的工件。这将通过P2P层的所有检查，然后客户端将注意到工件不符合其要求，例如，签名不正确。在进一步处理或将工件中继给其他节点之前，IC实现中的客户端总是执行验证检查以捕获此类攻击。

可分块的工件会进行单个块和整体验证，其中相应的客户端负责单个块的验证。

**重传请求**

在某些情况下，例如当节点注意到接收广告时出现错误，或者当它加入新子网时，它会向其节点发送重传请求。请求可以发送给特定的节点（例如，当检测到与该节点的连接问题时）或所有节点（例如，当节点加入时）。请求包含有关节点当前状态的信息，节点可以用广告响应来帮助节点从当前状态（如重传请求中所述）取得进展。

虽然重传请求主要是为了帮助节点追赶错过的广告，但它们也可能会定期发出，以确保没有错过任何内容。

**传输（Transport）**

P2P层的底层传输组件负责维护子网内节点之间的实际连接。它在节点之间创建基于TLS的TCP连接，双方都使用私钥进行身份验证。

每个节点都将其公钥存储在网络神经系统（NNS）的注册容器中。注册容器还包含最新的子网成员信息（哪些节点属于哪个子网）以及历史信息。每个节点通过查询注册容器了解自己的成员资格以及节点的IP地址和公钥。节点在建立TLS连接时始终确保只连接到子网内的节点，通过执行双向身份验证来实现这一点。

子网成员会随时间变化，节点会根据NNS接受的提案定期添加和移除子网。传输组件不断跟踪这些变化，并相应地调整连接。在某些情况下，节点需要与已不再位于最新注册容器条目的子网记录中的节点保持连接，而共识仍将它们视为子网的一部分，因此传输组件允许此类连接，直到不再需要它们为止。

传输组件还提供了保持连接活动的机制，快速识别连接问题（使用心跳机制）并在连接中断时自动重新连接。每当TCP连接空闲超过200毫秒时，就会发送一个心跳消息。在接收端，当超过5秒没有收到任何数据（包括心跳）时，连接将被断开并重新连接。这样做是为了避免等待TCP协议可能非常长的超时持续时间，这种情况有时会在互联网路由更改事件中发生。重新建立连接后，会向相应的节点发送重传请求。

总之，IC的P2P层负责在子网内部的节点之间传递消息。它使用一种称为广告的方法来节省带宽，并通过数据块将大型工件分割成更小的部分以便传输。传输组件维护节点之间的连接，并在需要时进行身份验证和重连。这个系统通过多种机制来确保消息传输的高效性和安全性。
